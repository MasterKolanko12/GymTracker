<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>GymTracker Final</title>
  <style>
    :root{
      --bg:#0f172a; --card-bg: #1e293b; --text:#e2e8f0; --muted:#94a3b8;
      --accent:#3b82f6; --success:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --gold: #fbbf24;
      --push:#f43f5e; --pull:#3b82f6; --legs:#10b981;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    
    body{
      margin:0; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color:var(--text);
      /* Extra padding for iPhone bottom bar */
      padding-bottom: 140px; 
      overflow-x: hidden;
    }

    /* DEBUG BAR (Tylko w razie awarii) */
    #debug-bar {
      display: none; background: #7f1d1d; color: #fff; padding: 15px;
      font-size: 12px; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;
      border-bottom: 2px solid #ef4444; white-space: pre-wrap;
    }

    /* MENU & MODALS */
    .menu-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8); z-index: 900;
      opacity: 0; pointer-events: none; transition: 0.3s;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
    }
    .menu-overlay.open { opacity: 1; pointer-events: all; }

    .sidebar {
      position: fixed; top:0; left:-85%; width: 85%; max-width: 320px; height: 100%;
      background: #162032; z-index: 1000;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 5px 0 25px rgba(0,0,0,0.5);
      display: flex; flex-direction: column;
      border-right: 1px solid rgba(255,255,255,0.05);
    }
    .sidebar.open { transform: translateX(100%); }

    .modal {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95);
      width: 90%; max-width: 400px; max-height: 85vh;
      background: #1e293b; border-radius: 16px; z-index: 1100;
      padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.7);
      opacity: 0; pointer-events: none; transition: 0.2s;
      border: 1px solid rgba(255,255,255,0.1); overflow-y: auto;
    }
    .modal.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
    .modal-close { position: absolute; top: 10px; right: 10px; background:none; border:none; color:var(--muted); font-size:24px; cursor:pointer; padding: 5px;}

    /* STYLES */
    .profile-header { padding: 30px 20px; background: linear-gradient(180deg, rgba(59,130,246,0.15) 0%, rgba(0,0,0,0) 100%); text-align: center; border-bottom: 1px solid #333; }
    .rank-title { font-size: 22px; font-weight: 800; color: var(--gold); margin: 5px 0; }
    .xp-bar-container { background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; margin: 10px 0 5px; overflow: hidden; }
    .xp-bar-fill { background: var(--gold); height: 100%; width: 0%; transition: width 0.5s ease; }
    
    .menu-scroll { flex: 1; overflow-y: auto; padding: 16px; -webkit-overflow-scrolling: touch; }
    .menu-btn { width: 100%; background: rgba(255,255,255,0.05); border:none; padding: 14px; color: #fff; text-align: left; margin-bottom: 8px; border-radius: 10px; display: flex; align-items: center; gap: 12px; font-size: 16px; cursor: pointer; }
    
    .app { max-width: 800px; margin: 0 auto; padding: 16px; transition: 0.3s; }
    .card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.05); }
    
    .input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 14px; border-radius: 12px; width: 100%; font-size: 16px; -webkit-appearance: none; }
    .btn { padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; }
    .btn.primary { background: var(--accent); color: white; }
    .btn.success { background: var(--success); color: #003311; }
    .btn.ghost { background: transparent; color: var(--muted); border: 1px solid rgba(255,255,255,0.1); }
    .btn.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

    /* EXERCISE */
    .exercise { background: #26334d; border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .note-area {
      width: 100%; background: rgba(0,0,0,0.2); border: 1px dashed rgba(255,255,255,0.1);
      color: var(--muted); font-size: 14px; padding: 10px; border-radius: 8px;
      margin-top: 10px; resize: none; font-family: inherit;
    }
    
    .set-row { display: grid; grid-template-columns: 30px 1fr 1fr 44px; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border-radius: 10px; background: rgba(0,0,0,0.2); }
    .set-row.done { background: rgba(34, 197, 94, 0.15); border: 1px solid rgba(34, 197, 94, 0.3); }
    .check-btn { width: 44px; height: 44px; border-radius: 10px; border: none; background: rgba(255,255,255,0.1); color: var(--muted); font-size: 20px; cursor: pointer; display:grid; place-items:center; }
    .check-btn.checked { background: var(--success); color: white; }

    /* TIMER */
    .timer-bar { 
      position: fixed; bottom: 0; left: 0; width: 100%; 
      background: #0f172a; border-top: 2px solid var(--accent); 
      /* iPhone padding fix */
      padding: 16px 16px 30px 16px; 
      z-index: 100; display: flex; align-items: center; justify-content: space-between; 
      transform: translateY(100%); transition: transform 0.3s; 
    }
    .timer-bar.active { transform: translateY(0); }
    .timer-big { font-family: monospace; font-size: 32px; font-weight: bold; color: white; }

    /* CHART SVG */
    .chart-container { width: 100%; height: 200px; margin-top: 20px; position: relative; border-left: 1px solid #555; border-bottom: 1px solid #555; }
    svg { width: 100%; height: 100%; overflow: visible; }
    circle { fill: var(--accent); }
    polyline { fill: none; stroke: var(--accent); stroke-width: 3; }
    
    .row { display: flex; gap: 10px; align-items: center; }
    .space-between { justify-content: space-between; }
    .history-item { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;}
    .tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-left:6px;}
    .tag.PUSH{background:var(--push)} .tag.PULL{background:var(--pull)} .tag.LEGS{background:var(--legs)}
  </style>
</head>
<body>

<div id="debug-bar">B≈ÇƒÖd. Zr√≥b screena: <span id="debug-msg"></span></div>

<div class="menu-overlay" id="overlay" onclick="closeAll()"></div>

<div class="sidebar" id="sidebar">
  <div class="profile-header">
    <div style="font-size:32px">ü•ã</div>
    <div class="rank-title" id="rankName">≈öwie≈ºak</div>
    <div class="xp-bar-container"><div class="xp-bar-fill" id="xpBar"></div></div>
    <div style="font-size:12px; color:var(--muted)">Do awansu: <span id="nextRankTarget">0</span> kg</div>
    <div style="margin-top:10px; background:rgba(245,158,11,0.2); color:var(--warn); padding:4px 10px; border-radius:20px; display:inline-block; font-weight:bold; font-size:13px">
      üî• <span id="streakCount">0</span> Dni Streaka
    </div>
  </div>

  <div class="menu-scroll">
    <div style="color:var(--muted); font-size:11px; margin-bottom:8px; text-transform:uppercase">Narzƒôdzia</div>
    <button class="menu-btn" onclick="openModal('chartModal')">üìà Wykresy Postƒôpu</button>
    <button class="menu-btn" onclick="openModal('weightModal')">‚öñÔ∏è Waga Cia≈Ça</button>
    <button class="menu-btn" onclick="openModal('calcModal')">üßÆ Kalkulator 1RM</button>
    
    <div style="color:var(--muted); font-size:11px; margin:16px 0 8px; text-transform:uppercase">Historia</div>
    <div id="sidebarHistoryList"></div>
    
    <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:20px; padding-top:20px">
      <button class="btn ghost" style="width:100%" onclick="exportData()">üì§ Eksport (Kopia)</button>
      <div style="height:10px"></div>
      <button class="btn ghost" style="width:100%; border-color:var(--warn); color:var(--warn)" onclick="document.getElementById('importFile').click()">üì• Importuj Dane</button>
    </div>
  </div>
</div>

<input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">

<div class="modal" id="chartModal">
  <button class="modal-close" onclick="closeAll()">‚úï</button>
  <h3>Wykresy Si≈Çy</h3>
  <select id="chartExerciseSelect" class="input" onchange="renderChart(this.value)">
    <option value="">Wybierz ƒáwiczenie...</option>
  </select>
  <div id="chartWrapper" style="text-align:center; margin-top:20px; color:var(--muted); height:200px; display:grid; place-items:center">
    Wybierz ƒáwiczenie powy≈ºej
  </div>
</div>

<div class="modal" id="weightModal">
  <button class="modal-close" onclick="closeAll()">‚úï</button>
  <h3>≈öledzenie Wagi</h3>
  <div class="row">
    <input type="number" id="weightInput" class="input" placeholder="kg" style="flex:1">
    <button class="btn primary" onclick="addWeight()">Dodaj</button>
  </div>
  <div id="weightChartWrapper" style="margin:20px 0; height:150px"></div>
  <div id="weightHistoryList" style="max-height:200px; overflow-y:auto; font-size:14px"></div>
</div>

<div class="modal" id="calcModal">
  <button class="modal-close" onclick="closeAll()">‚úï</button>
  <h3>Kalkulator 1RM</h3>
  <label style="font-size:12px; color:var(--muted)">Ciƒô≈ºar (kg)</label>
  <input type="number" id="rmWeight" class="input" style="margin-bottom:10px">
  <label style="font-size:12px; color:var(--muted)">Powt√≥rzenia</label>
  <input type="number" id="rmReps" class="input" style="margin-bottom:20px">
  <button class="btn primary" style="width:100%" onclick="calc1RM()">Oblicz</button>
  <div id="rmResult" style="margin-top:20px; text-align:center; font-size:18px; font-weight:bold; color:var(--accent)"></div>
</div>

<div class="app">
  <header class="row space-between" style="margin-bottom: 20px;">
    <button class="btn ghost" onclick="toggleSidebar()" style="font-size: 24px; padding: 8px 14px;">‚ò∞</button>
    <h2 style="margin:0">GymTracker</h2>
    <div style="width: 40px;"></div>
  </header>

  <div class="card">
    <div class="row" style="gap:8px">
      <input type="date" id="dateInput" class="input" style="flex:2">
      <select id="dayTypeInput" class="input" style="flex:1.5; padding: 14px 4px;">
        <option value="PUSH">PUSH</option>
        <option value="PULL">PULL</option>
        <option value="LEGS">LEGS</option>
      </select>
    </div>
  </div>

  <div id="exercisesList"></div>

  <button class="btn primary" id="addExerciseBtn" style="width:100%; padding: 16px; margin-top:10px">+ DODAJ ƒÜWICZENIE</button>
  <div style="height: 20px"></div>
  <button class="btn success" id="saveBtn" style="width:100%; padding: 16px;">üíæ ZAPISZ TRENING</button>
</div>

<div class="timer-bar" id="timerBar">
  <div>
    <div style="font-size:10px; color:var(--muted); letter-spacing:1px">PRZERWA</div>
    <div class="timer-big" id="timerDisplay">02:00</div>
  </div>
  <div class="row">
    <button class="btn ghost" onclick="addTime(-10)">-10s</button>
    <button class="btn ghost" onclick="addTime(10)">+10s</button>
    <button class="btn danger" onclick="stopTimer()">STOP</button>
  </div>
</div>

<template id="exerciseTemplate">
  <div class="exercise">
    <div class="row space-between" style="margin-bottom:5px">
      <input class="input" data-role="name" placeholder="Nazwa ƒáwiczenia..." style="font-weight:bold; border:none; padding:8px 0; border-radius:0; border-bottom:1px solid #ffffff20; background:transparent">
      <button class="btn ghost" data-role="removeEx" style="color:var(--danger); padding:5px 10px;">‚úï</button>
    </div>
    <textarea class="note-area" data-role="note" placeholder="Notatka / Ustawienia maszyny..." rows="1"></textarea>
    <div class="sets-container" data-role="sets" style="margin-top:10px"></div>
    <button class="btn ghost" style="width:100%; font-size:12px; margin-top:8px" data-role="addSet">+ Seria</button>
  </div>
</template>

<template id="setRowTemplate">
  <div class="set-row">
    <div style="color:var(--muted); font-size:12px; text-align:center" data-role="idx">1</div>
    <input type="number" class="input" data-role="weight" placeholder="kg">
    <input type="number" class="input" data-role="reps" placeholder="powt">
    <button class="check-btn" data-role="check">‚úî</button>
  </div>
</template>

<script>
window.onerror = function(msg, url, line) {
  document.getElementById('debug-bar').style.display = 'block';
  document.getElementById('debug-msg').textContent = msg + " (Line: " + line + ")";
};

// G≈Å√ìWNA LOGIKA BEZ SKR√ìT√ìW TYPU $ CZY $$
try {
  const STORAGE_KEY = 'eryk_gym_final';
  
  // RANGI
  const RANKS = [
    { name: '≈öwie≈ºak', min: 0 }, { name: 'Debiutant', min: 5000 },
    { name: 'PoczƒÖtkujƒÖcy', min: 15000 }, { name: 'Bywalec', min: 30000 },
    { name: 'Zapaleniec', min: 60000 }, { name: 'Amator', min: 100000 },
    { name: 'Pasjonat', min: 200000 }, { name: '≈öredniozaawansowany', min: 350000 },
    { name: 'Koks', min: 500000 }, { name: 'Kulturysta', min: 750000 },
    { name: 'Dzik', min: 1000000 }, { name: 'Bestia', min: 1500000 },
    { name: 'Goliat', min: 2500000 }, { name: 'Tytan', min: 3500000 },
    { name: 'Kr√≥l ≈ªelastwa', min: 5000000 }
  ];

  function loadData() {
    try {
      const d = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      if(!d.days) d.days = {};
      if(!d.notes) d.notes = {};
      if(!d.weightHistory) d.weightHistory = [];
      return d;
    } catch(e) { return { days: {}, notes: {}, weightHistory: [] }; }
  }
  function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    calcGamification();
  }

  // --- UI ---
  window.toggleSidebar = function() { 
    document.getElementById('sidebar').classList.add('open'); 
    document.getElementById('overlay').classList.add('open');
    renderSidebarHistory(); 
    calcGamification();
  }
  window.closeAll = function() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
  }
  window.openModal = function(id) {
    window.closeAll();
    document.getElementById('overlay').classList.add('open');
    const m = document.getElementById(id);
    if(m) m.classList.add('open');
    if(id === 'chartModal') initChartSelect();
    if(id === 'weightModal') renderWeightUI();
  }

  // --- EXERCISES ---
  window.loadDay = function(date) {
    document.getElementById('dateInput').value = date;
    const data = loadData();
    const dayData = data.days[date];
    const list = document.getElementById('exercisesList');
    list.innerHTML = '';
    
    if(dayData) {
      document.getElementById('dayTypeInput').value = dayData.dayType;
      dayData.exercises.forEach(ex => addExerciseElement(ex.name, ex.sets));
    }
  }

  window.addExerciseElement = function(name='', sets=[]) {
    const tpl = document.getElementById('exerciseTemplate').content.cloneNode(true);
    const el = tpl.querySelector('.exercise');
    document.getElementById('exercisesList').appendChild(el);

    const nameInput = el.querySelector('[data-role="name"]');
    const noteInput = el.querySelector('[data-role="note"]');
    nameInput.value = name;

    const data = loadData();
    if(name && data.notes[name]) noteInput.value = data.notes[name];

    noteInput.addEventListener('input', function() {
      const n = nameInput.value.trim();
      if(n) {
        const d = loadData();
        d.notes[n] = noteInput.value;
        saveData(d);
      }
    });
    
    const setsContainer = el.querySelector('[data-role="sets"]');
    
    function renderSet(w='', r='', isDone=false) {
      const sTpl = document.getElementById('setRowTemplate').content.cloneNode(true);
      const row = sTpl.querySelector('.set-row');
      const checkBtn = row.querySelector('[data-role="check"]');
      
      row.querySelector('[data-role="weight"]').value = w;
      row.querySelector('[data-role="reps"]').value = r;
      
      if(isDone) { row.classList.add('done'); checkBtn.classList.add('checked'); }
      
      checkBtn.onclick = function() {
        const nowDone = row.classList.toggle('done');
        checkBtn.classList.toggle('checked');
        if(nowDone) window.startAutoTimer();
      };
      
      const idxEl = row.querySelector('[data-role="idx"]'); 
      setsContainer.appendChild(row);
      updateIndices(setsContainer);
      
      // Swipe to delete logic could be here, but using button for simplicity
    }

    if(sets.length) sets.forEach(s => renderSet(s.weight, s.reps, s.done));
    else for(let i=0;i<3;i++) renderSet();

    el.querySelector('[data-role="addSet"]').onclick = function() {
       const last = setsContainer.lastElementChild;
       renderSet(last ? last.querySelector('[data-role="weight"]').value : '', '');
    };
    el.querySelector('[data-role="removeEx"]').onclick = function() { 
      if(confirm('UsunƒÖƒá ƒáwiczenie?')) el.remove(); 
    };
  }

  function updateIndices(c) { 
    Array.from(c.children).forEach((r,i) => {
      const idx = r.querySelector('[data-role="idx"]');
      if(idx) idx.textContent = i+1;
    }); 
  }

  function collectCurrentData() {
    const exercises = [];
    document.querySelectorAll('.exercise').forEach(el => {
      const name = el.querySelector('[data-role="name"]').value.trim();
      const sets = [];
      el.querySelectorAll('.set-row').forEach(row => {
        sets.push({
          weight: row.querySelector('[data-role="weight"]').value,
          reps: row.querySelector('[data-role="reps"]').value,
          done: row.classList.contains('done')
        });
      });
      exercises.push({ name, sets });
    });
    return { dayType: document.getElementById('dayTypeInput').value, exercises };
  }

  document.getElementById('saveBtn').onclick = function() {
    const date = document.getElementById('dateInput').value;
    const data = loadData();
    data.days[date] = collectCurrentData();
    saveData(data);
    alert('Zapisano!');
  };

  document.getElementById('addExerciseBtn').onclick = function() { addExerciseElement(); };
  document.getElementById('dateInput').onchange = function(e) { loadDay(e.target.value); };
  
  window.deleteDay = function(date) {
    if(confirm(`UsunƒÖƒá historiƒô z dnia ${date}?`)) {
      const d = loadData();
      delete d.days[date];
      saveData(d);
      renderSidebarHistory();
      if(document.getElementById('dateInput').value === date) {
        document.getElementById('exercisesList').innerHTML = '';
      }
    }
  }

  // --- GAMIFICATION ---
  function calcGamification() {
    const data = loadData();
    let totalVol = 0;
    const allDates = Object.keys(data.days).sort();
    const todayStr = new Date().toISOString().slice(0,10);

    allDates.forEach(d => {
      if(data.days[d] && data.days[d].exercises) {
        data.days[d].exercises.forEach(ex => {
          ex.sets.forEach(s => totalVol += (Number(s.weight||0)*Number(s.reps||0)));
        });
      }
    });

    let currentRank = RANKS[0], nextRank = RANKS[1];
    for(let i=0; i<RANKS.length; i++) {
      if(totalVol >= RANKS[i].min) { currentRank = RANKS[i]; nextRank = RANKS[i+1] || { min: totalVol*1.5 }; }
    }

    let streak = 0;
    const validDates = allDates.filter(d => d <= todayStr && data.days[d].exercises.length > 0);
    
    if(validDates.length > 0) {
      const lastDate = new Date(validDates[validDates.length-1]);
      const diff = Math.ceil(Math.abs(new Date(todayStr) - lastDate) / 86400000);
      if(diff <= 1) {
        streak = 1;
        for(let i=validDates.length-2; i>=0; i--) {
          const gap = (new Date(validDates[i+1]) - new Date(validDates[i])) / 86400000;
          if(gap === 1) streak++; else if(gap > 1) break;
        }
      }
    }

    document.getElementById('rankName').textContent = currentRank.name;
    document.getElementById('streakCount').textContent = streak;
    const xpPerc = Math.min(100, Math.max(0, ((totalVol-currentRank.min)/(nextRank.min-currentRank.min))*100));
    document.getElementById('xpBar').style.width = xpPerc + '%';
    document.getElementById('nextRankTarget').textContent = (nextRank.min - totalVol).toLocaleString();
  }

  function renderSidebarHistory() {
    const list = document.getElementById('sidebarHistoryList');
    list.innerHTML = '';
    const data = loadData();
    Object.keys(data.days).sort((a,b)=>new Date(b)-new Date(a)).forEach(d => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = `
        <div onclick="loadDay('${d}'); closeAll()" style="flex:1">
          <b>${d}</b> <span class="tag ${data.days[d].dayType}">${data.days[d].dayType}</span>
          <div style="font-size:11px; color:#aaa">${data.days[d].exercises.length} ƒáw.</div>
        </div>
        <button style="background:none; border:none; color:var(--danger); font-size:16px; padding:5px" onclick="deleteDay('${d}')">üóëÔ∏è</button>
      `;
      list.appendChild(div);
    });
  }

  // --- FEATURES ---
  let timerInt, timeLeft=120;
  window.startAutoTimer = function() {
    clearInterval(timerInt); timeLeft=120;
    document.getElementById('timerBar').classList.add('active'); updateTimer();
    timerInt = setInterval(function() { timeLeft--; updateTimer(); if(timeLeft<=0) window.stopTimer(); }, 1000);
  }
  window.stopTimer = function() { clearInterval(timerInt); document.getElementById('timerBar').classList.remove('active'); }
  window.addTime = function(s) { timeLeft+=s; updateTimer(); }
  function updateTimer() { document.getElementById('timerDisplay').textContent = `${Math.floor(timeLeft/60).toString().padStart(2,'0')}:${(timeLeft%60).toString().padStart(2,'0')}`; }

  window.calc1RM = function() {
    const w = Number(document.getElementById('rmWeight').value);
    const r = Number(document.getElementById('rmReps').value);
    if(w && r) {
      const max = Math.round(w * (36 / (37 - r)));
      document.getElementById('rmResult').textContent = max + " kg";
    }
  }

  window.renderWeightUI = function() {
    const d = loadData();
    const list = document.getElementById('weightHistoryList');
    list.innerHTML = '';
    const history = d.weightHistory.sort((a,b)=>new Date(b.date)-new Date(a.date));
    history.forEach(item => {
      const row = document.createElement('div');
      row.style.padding = "8px"; row.style.borderBottom="1px solid #333"; row.style.display="flex"; row.style.justifyContent="space-between";
      row.innerHTML = `<span>${item.date}</span> <b>${item.weight} kg</b> <span style="color:red; cursor:pointer" onclick="delWeight('${item.date}')">‚úï</span>`;
      list.appendChild(row);
    });
    if(history.length > 1) {
      const chartData = history.slice(0, 10).reverse().map(h => h.weight);
      drawSimpleChart('weightChartWrapper', chartData, history.slice(0,10).reverse().map(h=>h.date.slice(5)));
    } else {
      document.getElementById('weightChartWrapper').innerHTML = '<div style="text-align:center; padding-top:40px; color:#666">Dodaj min. 2 wpisy</div>';
    }
  }

  window.addWeight = function() {
    const val = Number(document.getElementById('weightInput').value);
    if(val) {
      const d = loadData();
      const today = new Date().toISOString().slice(0,10);
      d.weightHistory = d.weightHistory.filter(h => h.date !== today);
      d.weightHistory.push({ date: today, weight: val });
      saveData(d);
      document.getElementById('weightInput').value = '';
      renderWeightUI();
    }
  }
<script>
// 1. GLOBALNA OBS≈ÅUGA B≈ÅƒòD√ìW (Musi byƒá pierwsza)
window.onerror = function(msg, url, line) {
  document.getElementById('debug-bar').style.display = 'block';
  document.getElementById('debug-msg').textContent = msg + " (Line: " + line + ")";
};

// 2. STA≈ÅE (WyciƒÖgniƒôte na zewnƒÖtrz, ≈ºeby Safari je widzia≈Ço)
const STORAGE_KEY = 'eryk_gym_final_v2';

const RANKS = [
  { name: '≈öwie≈ºak', min: 0 },
  { name: 'Debiutant', min: 5000 },
  { name: 'PoczƒÖtkujƒÖcy', min: 15000 },
  { name: 'Bywalec', min: 30000 },
  { name: 'Zapaleniec', min: 60000 },
  { name: 'Amator', min: 100000 },
  { name: 'Pasjonat', min: 200000 },
  { name: '≈öredniozaawansowany', min: 350000 },
  { name: 'Koks', min: 500000 },
  { name: 'Kulturysta', min: 750000 },
  { name: 'Dzik', min: 1000000 },
  { name: 'Bestia', min: 1500000 },
  { name: 'Goliat', min: 2500000 },
  { name: 'Tytan', min: 3500000 },
  { name: 'Kr√≥l ≈ªelastwa', min: 5000000 }
];

// 3. G≈Å√ìWNA LOGIKA
try {
  
  function loadData() {
    try {
      const d = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      if(!d.days) d.days = {};
      if(!d.notes) d.notes = {};
      if(!d.weightHistory) d.weightHistory = [];
      return d;
    } catch(e) { return { days: {}, notes: {}, weightHistory: [] }; }
  }
  
  function saveData(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    calcGamification();
  }

  // --- UI FUNCTIONS ---
  window.toggleSidebar = function() { 
    document.getElementById('sidebar').classList.add('open'); 
    document.getElementById('overlay').classList.add('open');
    renderSidebarHistory(); 
    calcGamification();
  }
  
  window.closeAll = function() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
    document.querySelectorAll('.modal').forEach(function(m) { m.classList.remove('open'); });
  }
  
  window.openModal = function(id) {
    window.closeAll();
    document.getElementById('overlay').classList.add('open');
    const m = document.getElementById(id);
    if(m) m.classList.add('open');
    if(id === 'chartModal') initChartSelect();
    if(id === 'weightModal') renderWeightUI();
  }

  // --- EXERCISES LOGIC ---
  window.loadDay = function(date) {
    document.getElementById('dateInput').value = date;
    const data = loadData();
    const dayData = data.days[date];
    const list = document.getElementById('exercisesList');
    list.innerHTML = '';
    
    if(dayData) {
      document.getElementById('dayTypeInput').value = dayData.dayType;
      dayData.exercises.forEach(function(ex) { 
        addExerciseElement(ex.name, ex.sets); 
      });
    }
  }

  window.addExerciseElement = function(name, sets) {
    // Domy≈õlne warto≈õci
    if(!name) name = '';
    if(!sets) sets = [];

    const tpl = document.getElementById('exerciseTemplate').content.cloneNode(true);
    const el = tpl.querySelector('.exercise');
    document.getElementById('exercisesList').appendChild(el);

    const nameInput = el.querySelector('[data-role="name"]');
    const noteInput = el.querySelector('[data-role="note"]');
    nameInput.value = name;

    const data = loadData();
    if(name && data.notes[name]) noteInput.value = data.notes[name];

    noteInput.addEventListener('input', function() {
      const n = nameInput.value.trim();
      if(n) {
        const d = loadData();
        d.notes[n] = noteInput.value;
        saveData(d);
      }
    });
    
    const setsContainer = el.querySelector('[data-role="sets"]');
    
    function renderSet(w, r, isDone) {
      if(!w) w = ''; if(!r) r = ''; if(!isDone) isDone = false;

      const sTpl = document.getElementById('setRowTemplate').content.cloneNode(true);
      const row = sTpl.querySelector('.set-row');
      const checkBtn = row.querySelector('[data-role="check"]');
      
      row.querySelector('[data-role="weight"]').value = w;
      row.querySelector('[data-role="reps"]').value = r;
      
      if(isDone) { row.classList.add('done'); checkBtn.classList.add('checked'); }
      
      checkBtn.onclick = function() {
        const nowDone = row.classList.toggle('done');
        checkBtn.classList.toggle('checked');
        if(nowDone) window.startAutoTimer();
      };
      
      setsContainer.appendChild(row);
      updateIndices(setsContainer);
    }

    if(sets.length > 0) {
        sets.forEach(function(s) { renderSet(s.weight, s.reps, s.done); });
    } else {
        for(let i=0; i<3; i++) renderSet();
    }

    el.querySelector('[data-role="addSet"]').onclick = function() {
       const last = setsContainer.lastElementChild;
       let val = '';
       if(last) val = last.querySelector('[data-role="weight"]').value;
       renderSet(val, '');
    };
    
    el.querySelector('[data-role="removeEx"]').onclick = function() { 
      if(confirm('UsunƒÖƒá ƒáwiczenie?')) el.remove(); 
    };
  }

  function updateIndices(c) { 
    Array.from(c.children).forEach(function(r,i) {
      const idx = r.querySelector('[data-role="idx"]');
      if(idx) idx.textContent = i+1;
    }); 
  }

  function collectCurrentData() {
    const exercises = [];
    document.querySelectorAll('.exercise').forEach(function(el) {
      const name = el.querySelector('[data-role="name"]').value.trim();
      const sets = [];
      el.querySelectorAll('.set-row').forEach(function(row) {
        sets.push({
          weight: row.querySelector('[data-role="weight"]').value,
          reps: row.querySelector('[data-role="reps"]').value,
          done: row.classList.contains('done')
        });
      });
      exercises.push({ name: name, sets: sets });
    });
    return { dayType: document.getElementById('dayTypeInput').value, exercises: exercises };
  }

  document.getElementById('saveBtn').onclick = function() {
    const date = document.getElementById('dateInput').value;
    const data = loadData();
    data.days[date] = collectCurrentData();
    saveData(data);
    alert('Zapisano!');
  };

  document.getElementById('addExerciseBtn').onclick = function() { addExerciseElement(); };
  document.getElementById('dateInput').onchange = function(e) { loadDay(e.target.value); };
  
  window.deleteDay = function(date) {
    if(confirm('UsunƒÖƒá historiƒô z dnia ' + date + '?')) {
      const d = loadData();
      delete d.days[date];
      saveData(d);
      renderSidebarHistory();
      if(document.getElementById('dateInput').value === date) {
        document.getElementById('exercisesList').innerHTML = '';
      }
    }
  }

  // --- GAMIFICATION ---
  function calcGamification() {
    const data = loadData();
    let totalVol = 0;
    const allDates = Object.keys(data.days).sort();
    const todayStr = new Date().toISOString().slice(0,10);

    allDates.forEach(function(d) {
      if(data.days[d] && data.days[d].exercises) {
        data.days[d].exercises.forEach(function(ex) {
          ex.sets.forEach(function(s) { 
            totalVol += (Number(s.weight||0)*Number(s.reps||0)); 
          });
        });
      }
    });

    let currentRank = RANKS[0];
    let nextRank = RANKS[1];

    for(let i=0; i<RANKS.length; i++) {
      if(totalVol >= RANKS[i].min) { 
          currentRank = RANKS[i]; 
          nextRank = RANKS[i+1] || { min: totalVol*1.5 }; 
      }
    }

    let streak = 0;
    const validDates = allDates.filter(function(d) { 
        return d <= todayStr && data.days[d].exercises.length > 0; 
    });
    
    if(validDates.length > 0) {
      const lastDate = new Date(validDates[validDates.length-1]);
      const diff = Math.ceil(Math.abs(new Date(todayStr) - lastDate) / 86400000);
      if(diff <= 1) {
        streak = 1;
        for(let i=validDates.length-2; i>=0; i--) {
          const gap = (new Date(validDates[i+1]) - new Date(validDates[i])) / 86400000;
          if(gap === 1) streak++; else if(gap > 1) break;
        }
      }
    }

    document.getElementById('rankName').textContent = currentRank.name;
    document.getElementById('streakCount').textContent = streak;
    
    let xpPerc = 0;
    if(nextRank.min > currentRank.min) {
        xpPerc = Math.min(100, Math.max(0, ((totalVol-currentRank.min)/(nextRank.min-currentRank.min))*100));
    }
    document.getElementById('xpBar').style.width = xpPerc + '%';
    document.getElementById('nextRankTarget').textContent = (nextRank.min - totalVol).toLocaleString();
  }

  function renderSidebarHistory() {
    const list = document.getElementById('sidebarHistoryList');
    list.innerHTML = '';
    const data = loadData();
    const keys = Object.keys(data.days).sort(function(a,b){ return new Date(b)-new Date(a); });
    
    keys.forEach(function(d) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = 
        '<div onclick="loadDay(\''+d+'\'); closeAll()" style="flex:1">' +
          '<b>'+d+'</b> <span class="tag '+data.days[d].dayType+'">'+data.days[d].dayType+'</span>' +
          '<div style="font-size:11px; color:#aaa">'+data.days[d].exercises.length+' ƒáw.</div>' +
        '</div>' +
        '<button style="background:none; border:none; color:var(--danger); font-size:16px; padding:5px" onclick="deleteDay(\''+d+'\')">üóëÔ∏è</button>';
      list.appendChild(div);
    });
  }

  // --- FEATURES ---
  let timerInt;
  let timeLeft=120;
  
  window.startAutoTimer = function() {
    clearInterval(timerInt); 
    timeLeft=120;
    document.getElementById('timerBar').classList.add('active'); 
    updateTimer();
    timerInt = setInterval(function() { 
        timeLeft--; 
        updateTimer(); 
        if(timeLeft<=0) window.stopTimer(); 
    }, 1000);
  }
  
  window.stopTimer = function() { 
      clearInterval(timerInt); 
      document.getElementById('timerBar').classList.remove('active'); 
  }
  
  window.addTime = function(s) { timeLeft+=s; updateTimer(); }
  
  function updateTimer() { 
      const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
      const s = (timeLeft%60).toString().padStart(2,'0');
      document.getElementById('timerDisplay').textContent = m + ':' + s;
  }

  window.calc1RM = function() {
    const w = Number(document.getElementById('rmWeight').value);
    const r = Number(document.getElementById('rmReps').value);
    if(w && r) {
      const max = Math.round(w * (36 / (37 - r)));
      document.getElementById('rmResult').textContent = max + " kg";
    }
  }

  window.renderWeightUI = function() {
    const d = loadData();
    const list = document.getElementById('weightHistoryList');
    list.innerHTML = '';
    const history = d.weightHistory.sort(function(a,b){ return new Date(b.date)-new Date(a.date); });
    
    history.forEach(function(item) {
      const row = document.createElement('div');
      row.style.padding = "8px"; 
      row.style.borderBottom="1px solid #333"; 
      row.style.display="flex"; 
      row.style.justifyContent="space-between";
      row.innerHTML = '<span>'+item.date+'</span> <b>'+item.weight+' kg</b> <span style="color:red; cursor:pointer" onclick="delWeight(\''+item.date+'\')">‚úï</span>';
      list.appendChild(row);
    });
    
    if(history.length > 1) {
      const chartData = history.slice(0, 10).reverse().map(function(h){ return h.weight; });
      const chartLabels = history.slice(0,10).reverse().map(function(h){ return h.date.slice(5); });
      drawSimpleChart('weightChartWrapper', chartData, chartLabels);
    } else {
      document.getElementById('weightChartWrapper').innerHTML = '<div style="text-align:center; padding-top:40px; color:#666">Dodaj min. 2 wpisy</div>';
    }
  }

  window.addWeight = function() {
    const val = Number(document.getElementById('weightInput').value);
    if(val) {
      const d = loadData();
      const today = new Date().toISOString().slice(0,10);
      d.weightHistory = d.weightHistory.filter(function(h) { return h.date !== today; });
      d.weightHistory.push({ date: today, weight: val });
      saveData(d);
      document.getElementById('weightInput').value = '';
      renderWeightUI();
    }
  }
  
  window.delWeight = function(date) {
     if(confirm('UsunƒÖƒá wpis wagi?')) {
       const d = loadData();
       d.weightHistory = d.weightHistory.filter(function(h) { return h.date !== date; });
       saveData(d); renderWeightUI();
     }
  }

  window.initChartSelect = function() {
    const sel = document.getElementById('chartExerciseSelect');
    sel.innerHTML = '<option value="">Wybierz ƒáwiczenie...</option>';
    const d = loadData();
    const names = new Set();
    Object.values(d.days).forEach(function(day) {
        if(day.exercises) day.exercises.forEach(function(ex) { names.add(ex.name); });
    });
    names.forEach(function(n) {
      if(n) { 
          const opt = document.createElement('option'); 
          opt.value = n; 
          opt.textContent = n; 
          sel.appendChild(opt); 
      }
    });
  }

  window.renderChart = function(exName) {
    if(!exName) return;
    const d = loadData();
    const points = [];
    const sortedKeys = Object.keys(d.days).sort();
    
    sortedKeys.forEach(function(date) {
      const day = d.days[date];
      if(day.exercises) {
        const ex = day.exercises.find(function(e) { return e.name === exName; });
        if(ex) {
            let maxW = 0;
            ex.sets.forEach(function(s) { 
                if(Number(s.weight) > maxW) maxW = Number(s.weight); 
            });
            if(maxW > 0) points.push({ date: date.slice(5), val: maxW });
        }
      }
    });

    if(points.length > 1) {
      const vals = points.map(function(p){ return p.val; });
      const labs = points.map(function(p){ return p.date; });
      drawSimpleChart('chartWrapper', vals, labs);
    } else {
      document.getElementById('chartWrapper').innerHTML = '<div style="padding-top:40px">Za ma≈Ço danych<br>(min. 2 treningi z tym ƒáwiczeniem)</div>';
    }
  }

  function drawSimpleChart(containerId, data, labels) {
    const c = document.getElementById(containerId);
    c.innerHTML = '';
    const w = c.clientWidth || 300;
    const h = 150; 
    const pad = 20;

    const max = Math.max.apply(null, data) * 1.1;
    const min = Math.min.apply(null, data) * 0.9;
    const range = max - min || 1; 

    const getX = function(i) {
        const den = data.length - 1 || 1;
        return pad + (i / den) * (w - pad * 2);
    };
    const getY = function(v) { return h - pad - ((v - min) / range) * (h - pad * 2); };

    let svgHTML = '<svg viewBox="0 0 '+w+' '+h+'">';
    svgHTML += '<line x1="'+pad+'" y1="'+pad+'" x2="'+pad+'" y2="'+(h-pad)+'" stroke="#444" stroke-width="1"/>';
    svgHTML += '<line x1="'+pad+'" y1="'+(h-pad)+'" x2="'+(w-pad)+'" y2="'+(h-pad)+'" stroke="#444" stroke-width="1"/>';

    if(data.length > 0) {
        let dPath = 'M ' + getX(0) + ' ' + getY(data[0]) + ' ';
        for(let i=1; i<data.length; i++) dPath += 'L ' + getX(i) + ' ' + getY(data[i]) + ' ';
        svgHTML += '<polyline points="" d="'+dPath+'" />';

        data.forEach(function(val, i) {
<script>
// --- 1. GLOBALNA OBS≈ÅUGA B≈ÅƒòD√ìW (NA WSZELKI WYPADEK) ---
window.onerror = function(msg, url, line) {
  var bar = document.getElementById('debug-bar');
  if(bar) {
    bar.style.display = 'block';
    document.getElementById('debug-msg').textContent = msg + " (Linia: " + line + ")";
  }
  return false;
};

// --- 2. KONFIGURACJA I ZMIENNE GLOBALNE ---
var STORAGE_KEY = 'eryk_gym_final_v3';
var timerInt = null;
var timeLeft = 120;

var RANKS = [
  { name: '≈öwie≈ºak', min: 0 },
  { name: 'Debiutant', min: 5000 },
  { name: 'PoczƒÖtkujƒÖcy', min: 15000 },
  { name: 'Bywalec', min: 30000 },
  { name: 'Zapaleniec', min: 60000 },
  { name: 'Amator', min: 100000 },
  { name: 'Pasjonat', min: 200000 },
  { name: '≈öredniozaawansowany', min: 350000 },
  { name: 'Koks', min: 500000 },
  { name: 'Kulturysta', min: 750000 },
  { name: 'Dzik', min: 1000000 },
  { name: 'Bestia', min: 1500000 },
  { name: 'Goliat', min: 2500000 },
  { name: 'Tytan', min: 3500000 },
  { name: 'Kr√≥l ≈ªelastwa', min: 5000000 }
];

// --- 3. FUNKCJE BAZOWE (POZA BLOKAMI TRY/CATCH) ---

function loadData() {
  try {
    var str = localStorage.getItem(STORAGE_KEY);
    var d = str ? JSON.parse(str) : {};
    if(!d.days) d.days = {};
    if(!d.notes) d.notes = {};
    if(!d.weightHistory) d.weightHistory = [];
    return d;
  } catch(e) {
    console.error(e);
    return { days: {}, notes: {}, weightHistory: [] };
  }
}

function saveData(data) {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    calcGamification();
  } catch(e) {
    alert("B≈ÇƒÖd zapisu (Pamiƒôƒá pe≈Çna lub tryb prywatny): " + e.message);
  }
}

// --- 4. FUNKCJE UI (MENU, MODALE) ---

function toggleSidebar() { 
  document.getElementById('sidebar').classList.add('open'); 
  document.getElementById('overlay').classList.add('open');
  renderSidebarHistory(); 
  calcGamification();
}

function closeAll() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('open');
  var modals = document.querySelectorAll('.modal');
  for(var i=0; i<modals.length; i++) {
    modals[i].classList.remove('open');
  }
}

function openModal(id) {
  closeAll();
  document.getElementById('overlay').classList.add('open');
  var m = document.getElementById(id);
  if(m) m.classList.add('open');
  if(id === 'chartModal') initChartSelect();
  if(id === 'weightModal') renderWeightUI();
}

// --- 5. LOGIKA ƒÜWICZE≈É ---

function loadDay(date) {
  document.getElementById('dateInput').value = date;
  var data = loadData();
  var dayData = data.days[date];
  var list = document.getElementById('exercisesList');
  list.innerHTML = '';
  
  if(dayData) {
    document.getElementById('dayTypeInput').value = dayData.dayType;
    if(dayData.exercises) {
      for(var i=0; i<dayData.exercises.length; i++) {
        var ex = dayData.exercises[i];
        addExerciseElement(ex.name, ex.sets);
      }
    }
  }
}

function addExerciseElement(name, sets) {
  if(!name) name = '';
  if(!sets) sets = [];

  var tpl = document.getElementById('exerciseTemplate').content.cloneNode(true);
  var el = tpl.querySelector('.exercise');
  document.getElementById('exercisesList').appendChild(el);

  var nameInput = el.querySelector('[data-role="name"]');
  var noteInput = el.querySelector('[data-role="note"]');
  nameInput.value = name;

  // ≈Åadowanie notatki
  var data = loadData();
  if(name && data.notes[name]) noteInput.value = data.notes[name];

  // Zapis notatki
  noteInput.addEventListener('input', function() {
    var n = nameInput.value.trim();
    if(n) {
      var d = loadData();
      d.notes[n] = noteInput.value;
      saveData(d);
    }
  });
  
  var setsContainer = el.querySelector('[data-role="sets"]');
  
  // Funkcja renderujƒÖca seriƒô
  function renderSet(w, r, isDone) {
    if(!w) w = ''; if(!r) r = ''; 

    var sTpl = document.getElementById('setRowTemplate').content.cloneNode(true);
    var row = sTpl.querySelector('.set-row');
    var checkBtn = row.querySelector('[data-role="check"]');
    
    row.querySelector('[data-role="weight"]').value = w;
    row.querySelector('[data-role="reps"]').value = r;
    
    if(isDone) { 
      row.classList.add('done'); 
      checkBtn.classList.add('checked'); 
    }
    
    checkBtn.onclick = function() {
      var nowDone = row.classList.toggle('done');
      checkBtn.classList.toggle('checked');
      if(nowDone) startAutoTimer();
    };
    
    setsContainer.appendChild(row);
    updateIndices(setsContainer);
  }

  if(sets.length > 0) {
    for(var j=0; j<sets.length; j++) {
      renderSet(sets[j].weight, sets[j].reps, sets[j].done);
    }
  } else {
    for(var k=0; k<3; k++) renderSet();
  }

  el.querySelector('[data-role="addSet"]').onclick = function() {
     var last = setsContainer.lastElementChild;
     var val = '';
     if(last) val = last.querySelector('[data-role="weight"]').value;
     renderSet(val, '');
  };
  
  el.querySelector('[data-role="removeEx"]').onclick = function() { 
    if(confirm('UsunƒÖƒá ƒáwiczenie?')) el.remove(); 
  };
}

function updateIndices(container) { 
  var rows = container.children;
  for(var i=0; i<rows.length; i++) {
    var idx = rows[i].querySelector('[data-role="idx"]');
    if(idx) idx.textContent = (i+1);
  }
}

// ZAPIS TRENINGU
document.getElementById('saveBtn').onclick = function() {
  var date = document.getElementById('dateInput').value;
  var exercises = [];
  
  var exEls = document.querySelectorAll('.exercise');
  for(var i=0; i<exEls.length; i++) {
    var el = exEls[i];
    var name = el.querySelector('[data-role="name"]').value.trim();
    var setRows = el.querySelectorAll('.set-row');
    var sets = [];
    
    for(var j=0; j<setRows.length; j++) {
      var row = setRows[j];
      sets.push({
        weight: row.querySelector('[data-role="weight"]').value,
        reps: row.querySelector('[data-role="reps"]').value,
        done: row.classList.contains('done')
      });
    }
    exercises.push({ name: name, sets: sets });
  }

  var data = loadData();
  data.days[date] = { 
    dayType: document.getElementById('dayTypeInput').value, 
    exercises: exercises 
  };
  saveData(data);
  alert('Zapisano!');
};

// PRZYCISKI G≈Å√ìWNE
document.getElementById('addExerciseBtn').onclick = function() { addExerciseElement(); };
document.getElementById('dateInput').onchange = function(e) { loadDay(e.target.value); };

// USUWANIE DNIA
function deleteDay(date) {
  if(confirm('UsunƒÖƒá historiƒô z dnia ' + date + '?')) {
    var d = loadData();
    delete d.days[date];
    saveData(d);
    renderSidebarHistory();
    if(document.getElementById('dateInput').value === date) {
      document.getElementById('exercisesList').innerHTML = '';
    }
  }
}

// --- 6. GRYWALIZACJA ---

function calcGamification() {
  var data = loadData();
  var totalVol = 0;
  var allDates = Object.keys(data.days).sort();
  var todayStr = new Date().toISOString().slice(0,10);

  for(var i=0; i<allDates.length; i++) {
    var d = allDates[i];
    if(data.days[d] && data.days[d].exercises) {
      var exList = data.days[d].exercises;
      for(var j=0; j<exList.length; j++) {
        var sList = exList[j].sets;
        for(var k=0; k<sList.length; k++) {
          totalVol += (Number(sList[k].weight||0) * Number(sList[k].reps||0));
        }
      }
    }
  }

  var currentRank = RANKS[0];
  var nextRank = RANKS[1];

  for(var r=0; r<RANKS.length; r++) {
    if(totalVol >= RANKS[r].min) { 
        currentRank = RANKS[r]; 
        nextRank = RANKS[r+1] || { min: totalVol*1.5 }; 
    }
  }

  // Streak
  var streak = 0;
  var validDates = [];
  for(var dIdx=0; dIdx<allDates.length; dIdx++) {
    var dateKey = allDates[dIdx];
    if(dateKey <= todayStr && data.days[dateKey].exercises.length > 0) {
      validDates.push(dateKey);
    }
  }
  
  if(validDates.length > 0) {
    var lastDate = new Date(validDates[validDates.length-1]);
    var todayDate = new Date(todayStr);
    var diffTime = Math.abs(todayDate - lastDate);
    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    
    if(diffDays <= 1) {
      streak = 1;
      for(var v=validDates.length-2; v>=0; v--) {
        var d1 = new Date(validDates[v]);
        var d2 = new Date(validDates[v+1]);
        var gap = (d2 - d1) / (1000 * 3600 * 24);
        if(Math.round(gap) === 1) streak++; else if(Math.round(gap) > 1) break;
      }
    }
  }

  document.getElementById('rankName').textContent = currentRank.name;
  document.getElementById('streakCount').textContent = streak;
  
  var xpPerc = 0;
  if(nextRank.min > currentRank.min) {
      xpPerc = Math.min(100, Math.max(0, ((totalVol-currentRank.min)/(nextRank.min-currentRank.min))*100));
  }
  document.getElementById('xpBar').style.width = xpPerc + '%';
  document.getElementById('nextRankTarget').textContent = (nextRank.min - totalVol).toLocaleString();
}

function renderSidebarHistory() {
  var list = document.getElementById('sidebarHistoryList');
  list.innerHTML = '';
  var data = loadData();
  var keys = Object.keys(data.days).sort(function(a,b){ return new Date(b)-new Date(a); });
  
  for(var i=0; i<keys.length; i++) {
    var d = keys[i];
    var div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = 
      '<div onclick="loadDay(\''+d+'\'); closeAll()" style="flex:1">' +
        '<b>'+d+'</b> <span class="tag '+data.days[d].dayType+'">'+data.days[d].dayType+'</span>' +
        '<div style="font-size:11px; color:#aaa">'+data.days[d].exercises.length+' ƒáw.</div>' +
      '</div>' +
      '<button style="background:none; border:none; color:var(--danger); font-size:16px; padding:5px" onclick="deleteDay(\''+d+'\')">üóëÔ∏è</button>';
    list.appendChild(div);
  }
}

// --- 7. TIMER & DODATKI ---

function startAutoTimer() {
  if(timerInt) clearInterval(timerInt);
  timeLeft = 120;
  document.getElementById('timerBar').classList.add('active'); 
  updateTimer();
  timerInt = setInterval(function() { 
      timeLeft--; 
      updateTimer(); 
      if(timeLeft<=0) stopTimer(); 
  }, 1000);
}

function stopTimer() { 
    if(timerInt) clearInterval(timerInt); 
    document.getElementById('timerBar').classList.remove('active'); 
}

function addTime(s) { timeLeft+=s; updateTimer(); }

function updateTimer() { 
    var m = Math.floor(timeLeft/60).toString().padStart(2,'0');
    var s = (timeLeft%60).toString().padStart(2,'0');
    document.getElementById('timerDisplay').textContent = m + ':' + s;
}

// EXPORT / IMPORT / 1RM / WEIGHT
function exportData() {
   var b = new Blob([JSON.stringify(loadData())], {type: "application/json"});
   var a = document.createElement('a'); 
   a.href=URL.createObjectURL(b); 
   a.download="gym_backup.json"; 
   a.click();
}

function importData(input) {
  var file = input.files[0];
  if(!file) return;
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if(data.days || data.weightHistory) {
        if(confirm('To nadpisze obecne dane. Kontynuowaƒá?')) {
          saveData(data);
          alert('Dane wczytane!');
          location.reload();
        }
      } else {
        alert('B≈Çƒôdny plik.');
      }
    } catch(err) {
      alert('B≈ÇƒÖd: ' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

function calc1RM() {
  var w = Number(document.getElementById('rmWeight').value);
  var r = Number(document.getElementById('rmReps').value);
  if(w && r) {
    var max = Math.round(w * (36 / (37 - r)));
    document.getElementById('rmResult').textContent = max + " kg";
  }
}

function renderWeightUI() {
  var d = loadData();
  var list = document.getElementById('weightHistoryList');
  list.innerHTML = '';
  var history = d.weightHistory.sort(function(a,b){ return new Date(b.date)-new Date(a.date); });
  
  for(var i=0; i<history.length; i++) {
    var item = history[i];
    var row = document.createElement('div');
    row.style.padding = "8px"; 
    row.style.borderBottom="1px solid #333"; 
    row.style.display="flex"; 
    row.style.justifyContent="space-between";
    row.innerHTML = '<span>'+item.date+'</span> <b>'+item.weight+' kg</b> <span style="color:red; cursor:pointer" onclick="delWeight(\''+item.date+'\')">‚úï</span>';
    list.appendChild(row);
  }
  
  if(history.length > 1) {
    var chartData = history.slice(0, 10).reverse().map(function(h){ return h.weight; });
    var chartLabels = history.slice(0,10).reverse().map(function(h){ return h.date.slice(5); });
    drawSimpleChart('weightChartWrapper', chartData, chartLabels);
  } else {
    document.getElementById('weightChartWrapper').innerHTML = '<div style="text-align:center; padding-top:40px; color:#666">Dodaj min. 2 wpisy</div>';
  }
}

function addWeight() {
  var val = Number(document.getElementById('weightInput').value);
  if(val) {
    var d = loadData();
    var today = new Date().toISOString().slice(0,10);
    d.weightHistory = d.weightHistory.filter(function(h) { return h.date !== today; });
    d.weightHistory.push({ date: today, weight: val });
    saveData(d);
    document.getElementById('weightInput').value = '';
    renderWeightUI();
  }
}

function delWeight(date) {
   if(confirm('UsunƒÖƒá wpis wagi?')) {
     var d = loadData();
     d.weightHistory = d.weightHistory.filter(function(h) { return h.date !== date; });
     saveData(d); renderWeightUI();
   }
}

function initChartSelect() {
  var sel = document.getElementById('chartExerciseSelect');
  sel.innerHTML = '<option value="">Wybierz ƒáwiczenie...</option>';
  var d = loadData();
  var names = new Set();
  
  var keys = Object.keys(d.days);
  for(var i=0; i<keys.length; i++) {
    var day = d.days[keys[i]];
    if(day.exercises) {
        for(var j=0; j<day.exercises.length; j++) {
            names.add(day.exercises[j].name);
        }
    }
  }
  
  names.forEach(function(n) {
    if(n) { 
        var opt = document.createElement('option'); 
        opt.value = n; 
        opt.textContent = n; 
        sel.appendChild(opt); 
    }
  });
}

function renderChart(exName) {
  if(!exName) return;
  var d = loadData();
  var points = [];
  var sortedKeys = Object.keys(d.days).sort();
  
  for(var i=0; i<sortedKeys.length; i++) {
    var date = sortedKeys[i];
    var day = d.days[date];
    if(day.exercises) {
      var ex = null;
      for(var j=0; j<day.exercises.length; j++) {
         if(day.exercises[j].name === exName) { ex = day.exercises[j]; break; }
      }
      
      if(ex) {
          var maxW = 0;
          for(var k=0; k<ex.sets.length; k++) {
              if(Number(ex.sets[k].weight) > maxW) maxW = Number(ex.sets[k].weight);
          }
          if(maxW > 0) points.push({ date: date.slice(5), val: maxW });
      }
    }
  }

  if(points.length > 1) {
    var vals = points.map(function(p){ return p.val; });
    var labs = points.map(function(p){ return p.date; });
    drawSimpleChart('chartWrapper', vals, labs);
  } else {
    document.getElementById('chartWrapper').innerHTML = '<div style="padding-top:40px">Za ma≈Ço danych<br>(min. 2 treningi z tym ƒáwiczeniem)</div>';
  }
}

function drawSimpleChart(containerId, data, labels) {
  var c = document.getElementById(containerId);
  c.innerHTML = '';
  var w = c.clientWidth || 300;
  var h = 150; 
  var pad = 20;

  var max = Math.max.apply(null, data) * 1.1;
  var min = Math.min.apply(null, data) * 0.9;
  var range = max - min || 1; 

  function getX(i) {
      var den = data.length - 1 || 1;
      return pad + (i / den) * (w - pad * 2);
  }
  function getY(v) { return h - pad - ((v - min) / range) * (h - pad * 2); }

  var svgHTML = '<svg viewBox="0 0 '+w+' '+h+'">';
  svgHTML += '<line x1="'+pad+'" y1="'+pad+'" x2="'+pad+'" y2="'+(h-pad)+'" stroke="#444" stroke-width="1"/>';
  svgHTML += '<line x1="'+pad+'" y1="'+(h-pad)+'" x2="'+(w-pad)+'" y2="'+(h-pad)+'" stroke="#444" stroke-width="1"/>';

  if(data.length > 0) {
      var dPath = 'M ' + getX(0) + ' ' + getY(data[0]) + ' ';
      for(var i=1; i<data.length; i++) dPath += 'L ' + getX(i) + ' ' + getY(data[i]) + ' ';
      svgHTML += '<polyline points="" d="'+dPath+'" />';

      for(var j=0; j<data.length; j++) {
        var x = getX(j);
        var y = getY(data[j]);
        svgHTML += '<circle cx="'+x+'" cy="'+y+'" r="4" />';
        svgHTML += '<text x="'+x+'" y="'+(y-10)+'" fill="#fff" font-size="10" text-anchor="middle">'+data[j]+'</text>';
        svgHTML += '<text x="'+x+'" y="'+(h-5)+'" fill="#888" font-size="9" text-anchor="middle">'+labels[j]+'</text>';
      }
  }
  
  svgHTML += '</svg>';
  c.innerHTML = svgHTML;
}

// --- 8. START APLIKACJI ---
var today = new Date().toISOString().slice(0,10);
document.getElementById('dateInput').value = today;
loadDay(today);
calcGamification();

</script>
</body>
</html>
